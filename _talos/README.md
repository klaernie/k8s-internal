# my talos machine deployment

## first try ever

According to quickstart this was fairly simple:

```sh
talosctl gen secrets -o secrets.yaml
talosctl gen config --with-secrets secrets.yaml talos https://talos.ak-online.be:6443
vi controlplane.yaml
vi worker.yaml
talosctl apply-config --insecure --nodes talos-api01.ak-online.be  --file controlplane.yaml
talosctl apply-config --insecure --nodes talos-api02.ak-online.be  --file controlplane.yaml
talosctl apply-config --insecure --nodes talos-api03.ak-online.be  --file controlplane.yaml
talosctl apply-config --insecure --nodes talos-w01.ak-online.be  --file worker.yaml
talosctl apply-config --insecure --nodes talos-w02.ak-online.be  --file worker.yaml
talosctl apply-config --insecure --nodes talos-w03.ak-online.be  --file worker.yaml
```

## the proper way

having migrated all secrets in this directory into sops-encrypted secret files,
I wanted to complete this for talos as well. Combined with the fact that my
current machine configs are generated by talos and then edited by hand I of
cause lost track what was default and what I changed along the way.

So, now the changes to the machine configs are split up:

- `patches-all.yaml` contains the changes that are needed for all nodes.
- `patches-controlplane.yaml` tracks the changes needed for only the controlplane.
- `patches-worker.yaml` are the changes only needed on the workers

`regenerate-configs.sh` then takes these patches and generates the new config files.

As an addon it also triggers a decryption of `secrets.enc.yaml` to recreate `secrets.yaml` when it's missing.

And finally, since `talosctl gen config` does not support setting the endpoints and nodes in the generated talosconfig, we patch it ourselves using yq.
